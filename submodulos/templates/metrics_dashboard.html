{% extends "base.html" %}

{% block title %}Dashboard de Monitoreo - SentinelNexus{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }
    
    .metric-card {
        background-color: #252525;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .metric-title {
        font-size: 1rem;
        color: #aaa;
        margin-bottom: 10px;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #fff;
    }
    
    .chart-container {
        background-color: #252525;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        height: 300px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard de Monitoreo</h1>
        <div>
            <span class="me-3 text-muted">
                <i class="fas fa-clock me-1"></i>Última actualización: <span id="last-update">-</span>
            </span>
            <button id="refresh-btn" class="btn btn-primary ms-3">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <!-- Tarjetas de métricas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">CPU Promedio (Cluster)</div>
                <div class="metric-value" id="avg-cpu">--</div>
                <div class="text-muted">Porcentaje</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Memoria Promedio (Cluster)</div>
                <div class="metric-value" id="avg-mem">--</div>
                <div class="text-muted">Porcentaje</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">VMs Activas</div>
                <div class="metric-value" id="active-vms">--</div>
                <div class="text-muted">Total</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Nodos Activos</div>
                <div class="metric-value" id="active-nodes">--</div>
                <div class="text-muted">Total</div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>Uso de CPU</h3>
                <div id="cpu-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h3>Uso de Memoria</h3>
                <div id="memory-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>I/O de Disco</h3>
                <div id="disk-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h3>Tráfico de Red</h3>
                <div id="network-chart" style="width: 100%; height: 250px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Top VMs -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h3 class="h5 mb-0">Top VMs por consumo de recursos</h3>
        </div>
        <div class="card-body bg-dark">
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>VM</th>
                            <th>Nodo</th>
                            <th>CPU</th>
                            <th>Memoria</th>
                            <th>Disco I/O</th>
                            <th>Red</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="top-vms-table">
                        <tr>
                            <td colspan="7" class="text-center">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Variables globales
    let cpuChart, memoryChart, diskChart, networkChart;
    
    // Inicializar gráficos
    function initCharts() {
        const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
        cpuChart = new Chart(cpuCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        
        const memoryCtx = document.getElementById('memory-chart').getContext('2d');
        memoryChart = new Chart(memoryCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        
        const diskCtx = document.getElementById('disk-chart').getContext('2d');
        diskChart = new Chart(diskCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        
        const networkCtx = document.getElementById('network-chart').getContext('2d');
        networkChart = new Chart(networkCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }
    
    // Cargar datos desde la API
    function loadMetricsData() {
        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Actualizando...';
        refreshBtn.disabled = true;
        
        fetch('/api/metrics/?timeframe=hour')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDashboard(data.data);
                } else if (data.fallback_data) {
                    // Usar datos de respaldo si están disponibles
                    updateDashboard(data.data);
                }
                
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error al cargar datos:', error);
            })
            .finally(() => {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualizar';
                refreshBtn.disabled = false;
            });
    }
    
    // Actualizar dashboard con los datos obtenidos
    function updateDashboard(data) {
        // Actualizar tarjetas de métricas
        document.getElementById('avg-cpu').textContent = data.averages.cpu.toFixed(1) + '%';
        document.getElementById('avg-mem').textContent = data.averages.memory.toFixed(1) + '%';
        document.getElementById('active-vms').textContent = data.averages.active_vms;
        document.getElementById('active-nodes').textContent = data.averages.active_nodes;
        
        // Actualizar gráficos
        updateCharts(data);
        
        // Actualizar tabla de VMs
        updateVmsTable(data.top_vms);
    }
    
    // Actualizar gráficos
    function updateCharts(data) {
        // Actualizar gráfico de CPU
        cpuChart.data.labels = data.timestamps;
        cpuChart.data.datasets = [];
        
        // Añadir datos de CPU para nodos
        if (data.cpu_history && data.cpu_history.nodes) {
            const nodeColors = ['#FF5722', '#FF9800', '#FFC107', '#FFEB3B'];
            
            Object.entries(data.cpu_history.nodes).forEach(([nodeName, values], index) => {
                cpuChart.data.datasets.push({
                    label: `CPU ${nodeName}`,
                    data: values,
                    borderColor: nodeColors[index % nodeColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                });
            });
        }
        
        // Actualizar gráfico de memoria
        memoryChart.data.labels = data.timestamps;
        memoryChart.data.datasets = [];
        
        // Añadir datos de memoria para nodos
        if (data.memory_history && data.memory_history.nodes) {
            const memColors = ['#2196F3', '#03A9F4', '#00BCD4', '#009688'];
            
            Object.entries(data.memory_history.nodes).forEach(([nodeName, values], index) => {
                memoryChart.data.datasets.push({
                    label: `Memoria ${nodeName}`,
                    data: values,
                    borderColor: memColors[index % memColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                });
            });
        }
        
        // Actualizar gráfico de disco
        diskChart.data.labels = data.timestamps;
        diskChart.data.datasets = [];
        
        // Añadir datos de disco para VMs
        if (data.disk_history) {
            const diskColors = ['#4CAF50', '#8BC34A', '#F44336', '#E91E63'];
            let colorIndex = 0;
            
            // Datos de lectura
            if (data.disk_history.read) {
                Object.entries(data.disk_history.read).slice(0, 3).forEach(([vmName, values]) => {
                    diskChart.data.datasets.push({
                        label: `${vmName} (Lectura)`,
                        data: values,
                        borderColor: diskColors[colorIndex % diskColors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.4
                    });
                    colorIndex++;
                });
            }
            
            // Datos de escritura
            if (data.disk_history.write) {
                Object.entries(data.disk_history.write).slice(0, 3).forEach(([vmName, values]) => {
                    diskChart.data.datasets.push({
                        label: `${vmName} (Escritura)`,
                        data: values,
                        borderColor: diskColors[colorIndex % diskColors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4
                    });
                    colorIndex++;
                });
            }
        }
        
        // Actualizar gráfico de red
        networkChart.data.labels = data.timestamps;
        networkChart.data.datasets = [];
        
        // Añadir datos de red para VMs
        if (data.network_history) {
            const netColors = ['#9C27B0', '#673AB7', '#3F51B5', '#F44336'];
            let colorIndex = 0;
            
            // Datos de entrada
            if (data.network_history.in) {
                Object.entries(data.network_history.in).slice(0, 3).forEach(([vmName, values]) => {
                    networkChart.data.datasets.push({
                        label: `${vmName} (Entrada)`,
                        data: values,
                        borderColor: netColors[colorIndex % netColors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.4
                    });
                    colorIndex++;
                });
            }
            
            // Datos de salida
            if (data.network_history.out) {
                Object.entries(data.network_history.out).slice(0, 3).forEach(([vmName, values]) => {
                    networkChart.data.datasets.push({
                        label: `${vmName} (Salida)`,
                        data: values,
                        borderColor: netColors[colorIndex % netColors.length],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4
                    });
                    colorIndex++;
                });
            }
        }
        
        // Actualizar todos los gráficos
        cpuChart.update();
        memoryChart.update();
        diskChart.update();
        networkChart.update();
    }
    
    // Actualizar tabla de VMs
    function updateVmsTable(vms) {
        const tableBody = document.getElementById('top-vms-table');
        tableBody.innerHTML = '';
        
        if (!vms || vms.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="7" class="text-center">No hay datos disponibles</td>';
            tableBody.appendChild(row);
            return;
        }
        
        vms.forEach(vm => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${vm.name}</td>
                <td>${vm.node}</td>
                <td>
                    <div class="progress">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: ${vm.cpu}%"
                             aria-valuenow="${vm.cpu}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="ms-2">${vm.cpu.toFixed(1)}%</span>
                </td>
                <td>
                    <div class="progress">
                        <div class="progress-bar bg-info" role="progressbar" style="width: ${vm.memory}%"
                             aria-valuenow="${vm.memory}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span class="ms-2">${vm.memory.toFixed(1)}%</span>
                </td>
                <td>${vm.disk_io.toFixed(1)} MB/s</td>
                <td>${vm.network.toFixed(1)} Mbps</td>
                <td>
                    <a href="/vms/${vm.node}/${vm.id}/" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Ver
                    </a>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar gráficos
        initCharts();
        
        // Cargar datos iniciales
        loadMetricsData();
        
        // Configurar botón de actualización
        document.getElementById('refresh-btn').addEventListener('click', function() {
            loadMetricsData();
        });
        
        // Actualizar automáticamente cada 60 segundos
        setInterval(loadMetricsData, 60000);
    });
</script>
{% endblock %}