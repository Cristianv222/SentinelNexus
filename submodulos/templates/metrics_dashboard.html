{% extends "base.html" %}

{% block title %}Métricas - SentinelNexus{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }
    
    .chart-container {
        background-color: #252525;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        height: 300px;
    }
    
    .metric-card {
        background-color: #252525;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 10px;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .filter-container {
        margin-bottom: 20px;
    }
    
    .filter-btn {
        background: #333;
        border: none;
        color: #e0e0e0;
        padding: 8px 15px;
        border-radius: 20px;
        margin-right: 5px;
        transition: all 0.2s;
    }
    
    .filter-btn:hover {
        background: #5c5b5bb0;
    }
    
    .filter-btn.active {
        background: #FF5722;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dashboard de Métricas</h1>
        <div>
            <span class="me-3 text-muted small">
                <i class="fas fa-clock me-1"></i>Última actualización: <span id="last-update"></span>
            </span>
            <button id="refresh-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>
    
    <!-- Filtros de tiempo -->
    <div class="filter-container">
        <button class="filter-btn active" data-timeframe="hour">Última hora</button>
        <button class="filter-btn" data-timeframe="day">Último día</button>
        <button class="filter-btn" data-timeframe="week">Última semana</button>
        <button class="filter-btn" data-timeframe="month">Último mes</button>
    </div>
    
    <!-- Resumen de métricas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">CPU Promedio (Cluster)</div>
                <div class="metric-value" id="avg-cpu">--</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Memoria Promedio (Cluster)</div>
                <div class="metric-value" id="avg-mem">--</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">VMs Activas</div>
                <div class="metric-value" id="active-vms">--</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-title">Nodos Activos</div>
                <div class="metric-value" id="active-nodes">--</div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="cpu-chart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="memory-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="disk-chart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="network-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Top VMs -->
    <div class="card">
        <div class="card-header">
            <h2 class="h5 mb-0">Top VMs por consumo de recursos</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>VM</th>
                            <th>Nodo</th>
                            <th>CPU</th>
                            <th>Memoria</th>
                            <th>Disco I/O</th>
                            <th>Red</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="top-vms-table">
                        <tr>
                            <td colspan="7" class="text-center">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Configuración de gráficos
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    color: '#e0e0e0'
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            x: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: '#aaa'
                }
            },
            y: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: '#aaa'
                },
                beginAtZero: true
            }
        }
    };
    
    // Inicializar gráficos vacíos
    const cpuChart = new Chart(
        document.getElementById('cpu-chart').getContext('2d'),
        {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Uso de CPU',
                        color: '#e0e0e0'
                    }
                }
            }
        }
    );
    
    const memoryChart = new Chart(
        document.getElementById('memory-chart').getContext('2d'),
        {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Uso de Memoria',
                        color: '#e0e0e0'
                    }
                }
            }
        }
    );
    
    const diskChart = new Chart(
        document.getElementById('disk-chart').getContext('2d'),
        {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'I/O de Disco',
                        color: '#e0e0e0'
                    }
                }
            }
        }
    );
    
    const networkChart = new Chart(
        document.getElementById('network-chart').getContext('2d'),
        {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Tráfico de Red',
                        color: '#e0e0e0'
                    }
                }
            }
        }
    );
    
    // Variables globales
    let currentTimeframe = 'hour';
    
    // Cargar datos
    function loadMetricsData(timeframe) {
        const loadingStart = new Date();
        
        // Actualizar UI para mostrar carga
        document.getElementById('refresh-btn').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Cargando...';
        
        // Realizar solicitud a la API
        fetch(`/api/metrics/?timeframe=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar gráficos
                    updateCharts(data.data);
                    
                    // Actualizar métricas promedio
                    updateAverages(data.data.averages);
                    
                    // Actualizar tabla de top VMs
                    updateTopVmsTable(data.data.top_vms);
                    
                    // Actualizar hora de última actualización
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                } else {
                    console.error('Error al cargar datos:', data.message);
                    
                    // Si hay datos de respaldo, usarlos
                    if (data.fallback_data) {
                        updateCharts(data.data);
                        updateAverages(data.data.averages);
                        updateTopVmsTable(data.data.top_vms);
                    }
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
            })
            .finally(() => {
                // Restaurar botón después de al menos 500ms (para evitar parpadeo)
                const elapsed = new Date() - loadingStart;
                setTimeout(() => {
                    document.getElementById('refresh-btn').innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualizar';
                }, Math.max(0, 500 - elapsed));
            });
    }
    
    // Función para actualizar gráficos
    function updateCharts(data) {
        // Actualizar etiquetas de tiempo (eje X)
        const timestamps = data.timestamps;
        
        // Actualizar gráfico de CPU
        updateCpuChart(timestamps, data.cpu_history);
        
        // Actualizar gráfico de memoria
        updateMemoryChart(timestamps, data.memory_history);
        
        // Actualizar gráfico de disco
        updateDiskChart(timestamps, data.disk_history);
        
        // Actualizar gráfico de red
        updateNetworkChart(timestamps, data.network_history);
    }
    
    function updateCpuChart(timestamps, cpuData) {
        // Limpiar datasets existentes
        cpuChart.data.labels = timestamps;
        cpuChart.data.datasets = [];
        
        // Añadir datos de nodos
        Object.entries(cpuData.nodes).forEach(([nodeName, values], index) => {
            cpuChart.data.datasets.push({
                label: `Nodo: ${nodeName}`,
                data: values,
                borderColor: getNodeColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        // Añadir datos de top VMs (solo las 3 primeras)
        const topVms = Object.entries(cpuData.vms).slice(0, 3);
        topVms.forEach(([vmName, values], index) => {
            cpuChart.data.datasets.push({
                label: `VM: ${vmName}`,
                data: values,
                borderColor: getVmColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        cpuChart.update();
    }
    
    function updateMemoryChart(timestamps, memoryData) {
        // Limpiar datasets existentes
        memoryChart.data.labels = timestamps;
        memoryChart.data.datasets = [];
        
        // Añadir datos de nodos
        Object.entries(memoryData.nodes).forEach(([nodeName, values], index) => {
            memoryChart.data.datasets.push({
                label: `Nodo: ${nodeName}`,
                data: values,
                borderColor: getNodeColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        // Añadir datos de top VMs (solo las 3 primeras)
        const topVms = Object.entries(memoryData.vms).slice(0, 3);
        topVms.forEach(([vmName, values], index) => {
            memoryChart.data.datasets.push({
                label: `VM: ${vmName}`,
                data: values,
                borderColor: getVmColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        memoryChart.update();
    }
    
    function updateDiskChart(timestamps, diskData) {
        // Limpiar datasets existentes
        diskChart.data.labels = timestamps;
        diskChart.data.datasets = [];
        
        // Obtener las 3 VMs con mayor I/O de disco
        const topVmNames = Object.keys(diskData.read).slice(0, 3);
        
        // Para cada VM, añadir lectura y escritura
        topVmNames.forEach((vmName, index) => {
            // Añadir datos de lectura
            diskChart.data.datasets.push({
                label: `${vmName} - Lectura`,
                data: diskData.read[vmName],
                borderColor: getDiskReadColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
            
            // Añadir datos de escritura
            diskChart.data.datasets.push({
                label: `${vmName} - Escritura`,
                data: diskData.write[vmName],
                borderColor: getDiskWriteColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        diskChart.update();
    }
    
    function updateNetworkChart(timestamps, networkData) {
        // Limpiar datasets existentes
        networkChart.data.labels = timestamps;
        networkChart.data.datasets = [];
        
        // Obtener las 3 VMs con mayor tráfico de red
        const topVmNames = Object.keys(networkData.in).slice(0, 3);
        
        // Para cada VM, añadir tráfico entrante y saliente
        topVmNames.forEach((vmName, index) => {
            // Añadir datos de tráfico entrante
            networkChart.data.datasets.push({
                label: `${vmName} - In`,
                data: networkData.in[vmName],
                borderColor: getNetInColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
            
            // Añadir datos de tráfico saliente
            networkChart.data.datasets.push({
                label: `${vmName} - Out`,
                data: networkData.out[vmName],
                borderColor: getNetOutColor(index),
                backgroundColor: 'transparent',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 3
            });
        });
        
        networkChart.update();
    }
    
    function updateAverages(averages) {
        // Actualizar valores de resumen
        document.getElementById('avg-cpu').textContent = `${averages.cpu}%`;
        document.getElementById('avg-mem').textContent = `${averages.memory}%`;
        document.getElementById('active-vms').textContent = averages.active_vms;
        document.getElementById('active-nodes').textContent = averages.active_nodes;
    }
    
    function updateTopVmsTable(vms) {
        const tableBody = document.getElementById('top-vms-table');
        tableBody.innerHTML = '';
        
        if (!vms || vms.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No hay datos disponibles</td></tr>';
            return;
        }
        
        // Crear filas para cada VM
        vms.forEach(vm => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${vm.name}</td>
                <td>${vm.node}</td>
                <td><div class="progress" style="height: 5px;"><div class="progress-bar bg-danger" role="progressbar" style="width: ${vm.cpu}%"></div></div> ${vm.cpu}%</td>
                <td><div class="progress" style="height: 5px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${vm.memory}%"></div></div> ${vm.memory}%</td>
                <td>${vm.disk_io.toFixed(1)} MB/s</td>
                <td>${vm.network.toFixed(1)} Mbps</td>
                <td>
                    <a href="/vms/${vm.node}/${vm.id}/" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Funciones auxiliares para colores
    function getNodeColor(index) {
        const colors = ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#8E24AA'];
        return colors[index % colors.length];
    }
    
    function getVmColor(index) {
        const colors = ['#FF5722', '#FF9800', '#9C27B0', '#3F51B5', '#009688'];
        return colors[index % colors.length];
    }
    
    function getDiskReadColor(index) {
        const colors = ['#00C853', '#64DD17', '#76FF03'];
        return colors[index % colors.length];
    }
    
    function getDiskWriteColor(index) {
        const colors = ['#F50057', '#D50000', '#C51162'];
        return colors[index % colors.length];
    }
    
    function getNetInColor(index) {
        const colors = ['#2196F3', '#03A9F4', '#00BCD4'];
        return colors[index % colors.length];
    }
    
    function getNetOutColor(index) {
        const colors = ['#FF9800', '#FF5722', '#F44336'];
        return colors[index % colors.length];
    }
    
    // Inicializar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar datos iniciales
        loadMetricsData(currentTimeframe);
        
        // Configurar botón de actualización
        document.getElementById('refresh-btn').addEventListener('click', function() {
            loadMetricsData(currentTimeframe);
        });
        
        // Configurar filtros de tiempo
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Actualizar botones
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Actualizar timeframe y cargar datos
                currentTimeframe = this.dataset.timeframe;
                loadMetricsData(currentTimeframe);
            });
        });
        
        // Actualizar cada 60 segundos
        setInterval(() => {
            loadMetricsData(currentTimeframe);
        }, 60000);
    });
</script>
{% endblock %}