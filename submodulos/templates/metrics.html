{% extends 'base.html' %} {% load static %} {% block title %}Métricas de
Servidores - SentinelNexus{% endblock %} {% block extra_css %}
<style>
  /* Estilos base para el dashboard */
  .server-card {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .server-card.expanded {
    background: linear-gradient(135deg, #1a2f5a 0%, #243d6e 100%);
  }

  .server-card::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: radial-gradient(
      circle,
      rgba(255, 255, 255, 0.1) 0%,
      transparent 70%
    );
    border-radius: 50%;
    transform: translate(50px, -50px);
  }

  .server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
  }

  .server-title {
    color: white;
    font-size: 1.8rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .expand-icon {
    color: rgba(255, 255, 255, 0.7);
    transition: transform 0.3s ease;
    font-size: 1.2rem;
    margin-left: auto;
  }

  .server-card.expanded .expand-icon {
    transform: rotate(180deg);
  }

  .server-status {
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-online {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
  }

  .status-offline {
    background: linear-gradient(135deg, #c0392b, #e74c3c);
    color: white;
  }

  .pulse {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    }
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .metric-item {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s ease;
  }

  .metric-item:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.15);
  }

  .metric-value {
    font-size: 2.2rem;
    font-weight: bold;
    color: white;
    margin-bottom: 5px;
  }

  .metric-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .chart-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }

  .chart-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 20px;
    height: 250px;
    position: relative;
  }

  .chart-title {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 15px;
    text-align: center;
  }

  /* Colores específicos para cada servidor */
  .server-principal {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .server-secundario {
    background: linear-gradient(135deg, #435ddf 0%, #5c61d8 100%);
  }

  .server-backup {
    background: linear-gradient(135deg, #4facfe 0%, #0b99eb 100%);
  }

  /* Progress bars circulares */
  .circular-progress {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto;
  }

  .circular-progress svg {
    transform: rotate(-90deg);
  }

  .circular-progress circle {
    fill: none;
    stroke-width: 8;
  }

  .circle-bg {
    stroke: rgba(255, 255, 255, 0.1);
  }

  .circle-progress {
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
  }

  /* Estilos para contenedor de VMs */
  .vms-container {
    display: none;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid rgba(255, 255, 255, 0.1);
    animation: slideDown 0.4s ease;
  }

  .vms-container.show {
    display: block;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      max-height: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      max-height: 3000px;
      transform: translateY(0);
    }
  }

  .vm-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .vm-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .vm-card:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .vm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .vm-name {
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .vm-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .vm-status.running {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
  }

  .vm-status.stopped {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
  }

  .vm-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
  }

  .vm-metric {
    text-align: center;
  }

  .vm-metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
  }

  .vm-metric-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
  }

  .vm-chart {
    height: 120px;
    margin-top: 15px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.2);
    padding: 10px;
  }

  .vm-actions {
    display: flex;
    gap: 8px;
    margin-top: 15px;
  }

  .vm-actions button {
    flex: 1;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .vm-btn-start {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
  }

  .vm-btn-stop {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
  }

  .vm-btn-restart {
    background: rgba(241, 196, 15, 0.2);
    color: #f1c40f;
  }

  .vm-btn-console {
    background: rgba(52, 152, 219, 0.2);
    color: #3498db;
  }

  .server-info {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
  }
</style>
{% endblock %} {% block content %}
<div
  class="container-fluid"
  style="background: #0f172a; min-height: 100vh; padding: 30px"
>
  <!-- Header Principal -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="text-center text-white">
        <h1 class="display-4 mb-3">
          <i class="fas fa-server me-3" style="color: #3498db"></i>
          Métricas de Servidores Proxmox
        </h1>
        <p class="lead" style="color: #94a3b8">
          Monitoreo detallado de los tres servidores principales
        </p>
      </div>
    </div>
  </div>

  <!-- Servidor Principal -->
  <div class="server-card server-principal" onclick="toggleVMs(1, event)">
    <div class="server-header">
      <div class="server-title">
        <i class="fas fa-crown"></i>
        <span id="server-name-1">Servidor Principal</span>
        <i class="fas fa-chevron-down expand-icon" id="expand-icon-1"></i>
      </div>
      <div class="server-status status-offline" id="server-status-1">
        <span class="pulse"></span>
        OFFLINE
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="cpu-circle-1"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #f39c12;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="cpu-text-1">0%</div>
        </div>
        <div class="metric-label mt-2">CPU</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="mem-circle-1"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #3498db;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="mem-text-1">0%</div>
        </div>
        <div class="metric-label mt-2">MEMORIA</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="disk-circle-1"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #2ecc71;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="disk-text-1">0%</div>
        </div>
        <div class="metric-label mt-2">DISCO</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="net-circle-1"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #e74c3c;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" style="font-size: 1rem">
            <span id="net-text-1" style="font-size: 1.2rem; font-weight: bold"
              >0%</span
            >
            <div id="net-mbps-1" style="font-size: 0.8rem; color: #aaa">
              0 Mbps
            </div>
          </div>
        </div>
        <div class="metric-label mt-2">RED (Load)</div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container">
        <div class="chart-title">Historial CPU (24h)</div>
        <canvas id="cpu-chart-1"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Historial Memoria (24h)</div>
        <canvas id="mem-chart-1"></canvas>
      </div>
    </div>

    <div class="server-info">
      <div class="info-item">
        <i class="fas fa-microchip"></i>
        <span>Cores: <strong id="cores-1">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-memory"></i>
        <span>RAM Total: <strong id="ram-total-1">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-hdd"></i>
        <span>Almacenamiento: <strong id="storage-1">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-cube"></i>
        <span>VMs Activas: <strong id="vms-1">0</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-clock"></i>
        <span>Uptime: <strong id="uptime-1">--</strong></span>
      </div>
    </div>

    <!-- Contenedor de VMs -->
    <div
      class="vms-container"
      id="vms-container-1"
      onclick="event.stopPropagation()"
    >
      <h4 style="color: white; margin-bottom: 20px">
        <i class="fas fa-cube me-2"></i>Máquinas Virtuales
      </h4>
      <div class="vm-grid" id="vm-grid-1">
        <!-- Las VMs se cargarán dinámicamente aquí -->
      </div>
    </div>
  </div>

  <!-- Servidor Secundario -->
  <div class="server-card server-secundario" onclick="toggleVMs(2, event)">
    <div class="server-header">
      <div class="server-title">
        <i class="fas fa-shield-alt"></i>
        <span id="server-name-2">Servidor Secundario</span>
        <i class="fas fa-chevron-down expand-icon" id="expand-icon-2"></i>
      </div>
      <div class="server-status status-offline" id="server-status-2">
        <span class="pulse"></span>
        OFFLINE
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="cpu-circle-2"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #f39c12;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="cpu-text-2">0%</div>
        </div>
        <div class="metric-label mt-2">CPU</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="mem-circle-2"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #3498db;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="mem-text-2">0%</div>
        </div>
        <div class="metric-label mt-2">MEMORIA</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="disk-circle-2"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #2ecc71;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="disk-text-2">0%</div>
        </div>
        <div class="metric-label mt-2">DISCO</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
            <svg width="120" height="120">
                <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
                <circle class="circle-progress" id="net-circle-2" cx="60" cy="60" r="54"
                        style="stroke: #e74c3c; stroke-dasharray: 339.292; stroke-dashoffset: 339.292;">
                </circle>
            </svg>
            <div class="progress-text" style="font-size: 1rem;">
                <span id="net-text-2" style="font-size: 1.2rem; font-weight: bold;">0%</span>
                <div id="net-mbps-2" style="font-size: 0.8rem; color: #aaa;">0 Mbps</div>
            </div>
        </div>
        <div class="metric-label mt-2">RED (Load)</div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container">
        <div class="chart-title">Historial CPU (24h)</div>
        <canvas id="cpu-chart-2"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Historial Memoria (24h)</div>
        <canvas id="mem-chart-2"></canvas>
      </div>
    </div>

    <div class="server-info">
      <div class="info-item">
        <i class="fas fa-microchip"></i>
        <span>Cores: <strong id="cores-2">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-memory"></i>
        <span>RAM Total: <strong id="ram-total-2">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-hdd"></i>
        <span>Almacenamiento: <strong id="storage-2">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-cube"></i>
        <span>VMs Activas: <strong id="vms-2">0</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-clock"></i>
        <span>Uptime: <strong id="uptime-2">--</strong></span>
      </div>
    </div>

    <!-- Contenedor de VMs -->
    <div
      class="vms-container"
      id="vms-container-2"
      onclick="event.stopPropagation()"
    >
      <h4 style="color: white; margin-bottom: 20px">
        <i class="fas fa-cube me-2"></i>Máquinas Virtuales
      </h4>
      <div class="vm-grid" id="vm-grid-2">
        <!-- Las VMs se cargarán dinámicamente aquí -->
      </div>
    </div>
  </div>

  <!-- Servidor Backup -->
  <div class="server-card server-backup" onclick="toggleVMs(3, event)">
    <div class="server-header">
      <div class="server-title">
        <i class="fas fa-database"></i>
        <span id="server-name-3">Servidor Backup</span>
        <i class="fas fa-chevron-down expand-icon" id="expand-icon-3"></i>
      </div>
      <div class="server-status status-offline" id="server-status-3">
        <span class="pulse"></span>
        OFFLINE
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="cpu-circle-3"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #f39c12;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="cpu-text-3">0%</div>
        </div>
        <div class="metric-label mt-2">CPU</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="mem-circle-3"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #3498db;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="mem-text-3">0%</div>
        </div>
        <div class="metric-label mt-2">MEMORIA</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
            <circle
              class="circle-progress"
              id="disk-circle-3"
              cx="60"
              cy="60"
              r="54"
              style="
                stroke: #2ecc71;
                stroke-dasharray: 339.292;
                stroke-dashoffset: 339.292;
              "
            ></circle>
          </svg>
          <div class="progress-text" id="disk-text-3">0%</div>
        </div>
        <div class="metric-label mt-2">DISCO</div>
      </div>

      <div class="metric-item">
        <div class="circular-progress">
            <svg width="120" height="120">
                <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
                <circle class="circle-progress" id="net-circle-3" cx="60" cy="60" r="54"
                        style="stroke: #e74c3c; stroke-dasharray: 339.292; stroke-dashoffset: 339.292;">
                </circle>
            </svg>
            <div class="progress-text" style="font-size: 1rem;">
                <span id="net-text-3" style="font-size: 1.2rem; font-weight: bold;">0%</span>
                <div id="net-mbps-3" style="font-size: 0.8rem; color: #aaa;">0 Mbps</div>
            </div>
        </div>
        <div class="metric-label mt-2">RED (Load)</div>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container">
        <div class="chart-title">Historial CPU (24h)</div>
        <canvas id="cpu-chart-3"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">Historial Memoria (24h)</div>
        <canvas id="mem-chart-3"></canvas>
      </div>
    </div>

    <div class="server-info">
      <div class="info-item">
        <i class="fas fa-microchip"></i>
        <span>Cores: <strong id="cores-3">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-memory"></i>
        <span>RAM Total: <strong id="ram-total-3">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-hdd"></i>
        <span>Almacenamiento: <strong id="storage-3">--</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-cube"></i>
        <span>VMs Activas: <strong id="vms-3">0</strong></span>
      </div>
      <div class="info-item">
        <i class="fas fa-clock"></i>
        <span>Uptime: <strong id="uptime-3">--</strong></span>
      </div>
    </div>

    <!-- Contenedor de VMs -->
    <div
      class="vms-container"
      id="vms-container-3"
      onclick="event.stopPropagation()"
    >
      <h4 style="color: white; margin-bottom: 20px">
        <i class="fas fa-cube me-2"></i>Máquinas Virtuales
      </h4>
      <div class="vm-grid" id="vm-grid-3">
        <!-- Las VMs se cargarán dinámicamente aquí -->
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="row mt-4">
    <div class="col-12 text-center">
      <button class="btn btn-primary btn-lg me-3" onclick="refreshAllMetrics()">
        <i class="fas fa-sync-alt me-2"></i>Actualizar Todo
      </button>
      <button class="btn btn-success btn-lg me-3" onclick="toggleAutoRefresh()">
        <i class="fas fa-play me-2" id="auto-refresh-icon"></i>
        <span id="auto-refresh-text">Auto-Actualización</span>
      </button>
      <button class="btn btn-info btn-lg" onclick="exportServerMetrics()">
        <i class="fas fa-download me-2"></i>Exportar Métricas
      </button>
    </div>
  </div>

  <!-- Añadir después de los gráficos históricos existentes -->
  <div
    class="predictions-section mt-4"
    id="predictions-container-{{ forloop.counter }}"
    style="display: none"
  >
    <h5 class="text-white mb-3">
      <i class="fas fa-chart-line me-2"></i>Predicciones ARIMA/SARIMA (Próximas
      24h)
    </h5>

    <div class="row">
      <!-- Predicción CPU -->
      <div class="col-md-4">
        <div class="prediction-card">
          <h6 class="text-warning">CPU</h6>
          <div class="prediction-value">
            <span class="current"
              >Actual:
              <strong id="cpu-current-{{ forloop.counter }}">--</strong></span
            >
            <span class="predicted"
              >24h:
              <strong id="cpu-predicted-{{ forloop.counter }}">--</strong></span
            >
            <span class="trend" id="cpu-trend-{{ forloop.counter }}">--</span>
          </div>
          <canvas
            id="cpu-prediction-chart-{{ forloop.counter }}"
            height="150"
          ></canvas>
        </div>
      </div>

      <!-- Predicción Memoria -->
      <div class="col-md-4">
        <div class="prediction-card">
          <h6 class="text-info">MEMORIA</h6>
          <div class="prediction-value">
            <span class="current"
              >Actual:
              <strong id="mem-current-{{ forloop.counter }}">--</strong></span
            >
            <span class="predicted"
              >24h:
              <strong id="mem-predicted-{{ forloop.counter }}">--</strong></span
            >
            <span class="trend" id="mem-trend-{{ forloop.counter }}">--</span>
          </div>
          <canvas
            id="mem-prediction-chart-{{ forloop.counter }}"
            height="150"
          ></canvas>
        </div>
      </div>

      <!-- Predicción Disco -->
      <div class="col-md-4">
        <div class="prediction-card">
          <h6 class="text-success">DISCO</h6>
          <div class="prediction-value">
            <span class="current"
              >Actual:
              <strong id="disk-current-{{ forloop.counter }}">--</strong></span
            >
            <span class="predicted"
              >24h:
              <strong id="disk-predicted-{{ forloop.counter }}"
                >--</strong
              ></span
            >
            <span class="trend" id="disk-trend-{{ forloop.counter }}">--</span>
          </div>
          <canvas
            id="disk-prediction-chart-{{ forloop.counter }}"
            height="150"
          ></canvas>
        </div>
      </div>
    </div>

    <!-- Alertas y Recomendaciones -->
    <div class="alerts-container mt-3" id="alerts-{{ forloop.counter }}">
      <!-- Se llenarán dinámicamente -->
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Variables globales
  let charts = {};
  let vmCharts = {};
  let autoRefreshInterval = null;
  let isAutoRefreshing = false;
  let expandedServers = {};
  let vmCache = {};

  // Configuración de Chart.js
  const chartConfig = {
    type: "line",
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false,
        },
      },
      scales: {
        x: {
          display: true,
          ticks: {
            color: "rgba(255, 255, 255, 0.5)",
            maxTicksLimit: 6,
          },
          grid: {
            color: "rgba(255, 255, 255, 0.1)",
          },
        },
        y: {
          display: true,
          ticks: {
            color: "rgba(255, 255, 255, 0.5)",
            callback: function (value) {
              return value + "%";
            },
          },
          grid: {
            color: "rgba(255, 255, 255, 0.1)",
          },
          min: 0,
          max: 100,
        },
      },
    },
  };

  // Inicializar gráficas
  function initCharts() {
    for (let i = 1; i <= 3; i++) {
      // Gráfica de CPU
      const cpuCtx = document.getElementById(`cpu-chart-${i}`);
      if (cpuCtx) {
        charts[`cpu-${i}`] = new Chart(cpuCtx.getContext("2d"), {
          ...chartConfig,
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                borderColor: "#f39c12",
                backgroundColor: "rgba(243, 156, 18, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
        });
      }

      // Gráfica de Memoria
      const memCtx = document.getElementById(`mem-chart-${i}`);
      if (memCtx) {
        charts[`mem-${i}`] = new Chart(memCtx.getContext("2d"), {
          ...chartConfig,
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
        });
      }
    }
  }

  // Actualizar círculo de progreso
  function updateCircularProgress(elementId, value) {
    const circle = document.getElementById(elementId);
    const text = document.getElementById(elementId.replace("circle", "text"));

    if (circle && text) {
      const circumference = 2 * Math.PI * 54;
      const offset = circumference - (value / 100) * circumference;

      circle.style.strokeDashoffset = offset;
      text.textContent = Math.round(value) + "%";
    }
  }

  // Cargar métricas de servidores
  async function loadServerMetrics() {
    try {
      console.log("Cargando métricas...");
      const response = await fetch("/api/metrics/");
      const data = await response.json();
      console.log("Datos recibidos:", data);

      if (data.success && data.servers) {
        data.servers.forEach((server, index) => {
          const serverNum = index + 1;

          // Actualizar nombre
          document.getElementById(`server-name-${serverNum}`).textContent =
            server.name;

          // Actualizar estado
          const statusElement = document.getElementById(
            `server-status-${serverNum}`
          );
          if (server.online) {
            statusElement.className = "server-status status-online";
            statusElement.innerHTML = '<span class="pulse"></span> ONLINE';
          } else {
            statusElement.className = "server-status status-offline";
            statusElement.innerHTML = '<span class="pulse"></span> OFFLINE';
          }

          // Actualizar círculos
          updateCircularProgress(
            `cpu-circle-${serverNum}`,
            server.metrics.cpu.usage || 0
          );
          updateCircularProgress(
            `mem-circle-${serverNum}`,
            server.metrics.memory.percent || 0
          );
          updateCircularProgress(
            `disk-circle-${serverNum}`,
            server.metrics.disk.percent || 0
          );

          // Actualizar red (Gauge)
          const netMbps = server.metrics.network?.out_mbps || 0;
          const netLoad = Math.min(netMbps, 100); // 100 Mbps = 100% load visualization
          
          // Si updateCircularProgress existe, usarla
          if (typeof updateCircularProgress === 'function') {
            updateCircularProgress(`net-circle-${serverNum}`, netLoad);
          }
          
          const netText = document.getElementById(`net-text-${serverNum}`);
          if (netText) netText.textContent = `${Math.round(netLoad)}%`;
          
          const netMbpsText = document.getElementById(`net-mbps-${serverNum}`);
          if (netMbpsText) netMbpsText.textContent = `${netMbps.toFixed(1)} Mbps`;

          // Actualizar información
          document.getElementById(`cores-${serverNum}`).textContent =
            server.metrics.cpu.cores || "--";
          document.getElementById(`ram-total-${serverNum}`).textContent = server
            .metrics.memory.total_gb
            ? `${server.metrics.memory.total_gb} GB`
            : "--";
          document.getElementById(`storage-${serverNum}`).textContent = server
            .metrics.disk.total_tb
            ? `${server.metrics.disk.total_tb.toFixed(2)} TB`
            : server.metrics.disk.total_gb
            ? `${server.metrics.disk.total_gb.toFixed(1)} GB`
            : "--";
          document.getElementById(`vms-${serverNum}`).textContent =
            server.vms?.active || "0";
          document.getElementById(`uptime-${serverNum}`).textContent =
            server.uptime || "--";

          // Actualizar gráficos
          if (server.history && server.history.timestamps.length > 0) {
            if (charts[`cpu-${serverNum}`]) {
              charts[`cpu-${serverNum}`].data.labels =
                server.history.timestamps;
              charts[`cpu-${serverNum}`].data.datasets[0].data =
                server.history.cpu;
              charts[`cpu-${serverNum}`].update();
            }

            if (charts[`mem-${serverNum}`]) {
              charts[`mem-${serverNum}`].data.labels =
                server.history.timestamps;
              charts[`mem-${serverNum}`].data.datasets[0].data =
                server.history.memory;
              charts[`mem-${serverNum}`].update();
            }
          }
        });
      }
    } catch (error) {
      console.error("Error cargando métricas:", error);
    }
  }

  // Toggle VMs
  function toggleVMs(serverNum, event) {
    event.stopPropagation();

    const container = document.getElementById(`vms-container-${serverNum}`);
    const card = container.closest(".server-card");

    if (container.classList.contains("show")) {
      container.classList.remove("show");
      card.classList.remove("expanded");
      expandedServers[serverNum] = false;
    } else {
      container.classList.add("show");
      card.classList.add("expanded");
      expandedServers[serverNum] = true;
      loadVMsForServer(serverNum);
    }
  }

  // Cargar VMs
  async function loadVMsForServer(serverNum) {
    try {
      // Usar caché si existe
      if (vmCache[serverNum]) {
        renderVMs(serverNum, vmCache[serverNum]);
      }

      const response = await fetch(`/api/server/${serverNum}/vms/`);
      const data = await response.json();

      if (data.success && data.vms) {
        vmCache[serverNum] = data.vms;
        renderVMs(serverNum, data.vms);
      } else {
        // Usar VMs de ejemplo si falla
        const mockVMs = [
          {
            id: `vm-${serverNum}-101`,
            vmid: 101,
            name: "VM-AVIRTUAL-POSGRADO-INV",
            status: "running",
            cpu: 15,
            memory: 45,
            disk: 25,
            uptime: "5d 12h",
            ip: "10.100.100.41",
          },
          {
            id: `vm-${serverNum}-104`,
            vmid: 104,
            name: "VM-BDD-METRICS",
            status: "running",
            cpu: 8,
            memory: 65,
            disk: 40,
            uptime: "3d 8h",
            ip: "10.100.100.44",
          },
        ];
        vmCache[serverNum] = mockVMs;
        renderVMs(serverNum, mockVMs);
      }
    } catch (error) {
      console.error("Error cargando VMs:", error);
      // Usar VMs de ejemplo en caso de error
      const mockVMs = [
        {
          id: `vm-${serverNum}-101`,
          vmid: 101,
          name: "VM-AVIRTUAL-POSGRADO-INV",
          status: "running",
          cpu: 15,
          memory: 45,
          disk: 25,
          uptime: "5d 12h",
          ip: "10.100.100.41",
        },
      ];
      vmCache[serverNum] = mockVMs;
      renderVMs(serverNum, mockVMs);
    }
  }

  // Renderizar VMs
  function renderVMs(serverNum, vms) {
    const grid = document.getElementById(`vm-grid-${serverNum}`);
    if (!grid) return;

    grid.innerHTML = "";

    vms.forEach((vm) => {
      const vmCard = createVMCard(vm);
      grid.appendChild(vmCard);

      setTimeout(() => {
        createVMChart(vm.id, vm);
      }, 100);
    });

    const activeVMs = vms.filter((vm) => vm.status === "running").length;
    document.getElementById(`vms-${serverNum}`).textContent = activeVMs;
  }

  // Crear tarjeta de VM
  function createVMCard(vm) {
    const card = document.createElement("div");
    card.className = "vm-card";
    card.innerHTML = `
        <div class="vm-header">
            <div>
                <div class="vm-name">
                    <i class="fas fa-server me-2"></i>${vm.name}
                </div>
                <small style="color: rgba(255,255,255,0.5);">
                    VMID: ${vm.vmid} | IP: ${vm.ip || "Sin IP"}
                </small>
            </div>
            <span class="vm-status ${vm.status}">
                ${
                  vm.status === "running"
                    ? '<i class="fas fa-play-circle me-1"></i>Running'
                    : '<i class="fas fa-stop-circle me-1"></i>Stopped'
                }
            </span>
        </div>
        
        <div class="vm-metrics">
            <div class="vm-metric">
                <div class="vm-metric-value" style="color: #f39c12;">${
                  vm.cpu
                }%</div>
                <div class="vm-metric-label">CPU</div>
            </div>
            <div class="vm-metric">
                <div class="vm-metric-value" style="color: #3498db;">${
                  vm.memory
                }%</div>
                <div class="vm-metric-label">RAM</div>
            </div>
            <div class="vm-metric">
                <div class="vm-metric-value" style="color: #2ecc71;">${
                  vm.disk
                }%</div>
                <div class="vm-metric-label">DISCO</div>
            </div>
        </div>
        
        <div class="vm-chart">
            <canvas id="chart-${vm.id}"></canvas>
        </div>
        
        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 10px;">
            <i class="fas fa-clock me-2"></i>Uptime: ${vm.uptime}
        </div>
        
        <div class="vm-actions">
            ${
              vm.status === "stopped"
                ? `<button class="vm-btn-start" onclick="controlVM('${vm.vmid}', 'start')">
                    <i class="fas fa-play"></i>
                </button>`
                : `<button class="vm-btn-stop" onclick="controlVM('${vm.vmid}', 'stop')">
                    <i class="fas fa-stop"></i>
                </button>`
            }
            <button class="vm-btn-restart" onclick="controlVM('${
              vm.vmid
            }', 'restart')">
                <i class="fas fa-sync"></i>
            </button>
            <button class="vm-btn-console" onclick="openVMConsole('${
              vm.vmid
            }')">
                <i class="fas fa-terminal"></i>
            </button>
        </div>
    `;

    return card;
  }

  // Crear mini gráfico para VM
  function createVMChart(vmId, vmData) {
    const ctx = document.getElementById(`chart-${vmId}`);
    if (!ctx) return;

    vmCharts[vmId] = new Chart(ctx.getContext("2d"), {
      type: "line",
      data: {
        labels: ["", "", "", "", "", ""],
        datasets: [
          {
            data: [
              vmData.cpu - 5,
              vmData.cpu - 3,
              vmData.cpu - 4,
              vmData.cpu - 2,
              vmData.cpu - 1,
              vmData.cpu,
            ],
            borderColor: "#f39c12",
            backgroundColor: "rgba(243, 156, 18, 0.1)",
            tension: 0.4,
            fill: true,
            pointRadius: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
        },
        scales: {
          x: { display: false },
          y: { display: false, min: 0, max: 100 },
        },
      },
    });
  }

  // Control de VM
  function controlVM(vmid, action) {
    console.log(`VM ${vmid} - Acción ${action}`);
  }

  // Abrir consola
  function openVMConsole(vmid) {
    window.open(`/vm/${vmid}/console/`, "_blank", "width=1024,height=768");
  }

  // Inicializar
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Inicializando dashboard...");
    initCharts();
    loadServerMetrics();

    // Auto-actualización cada 30 segundos
    setInterval(() => {
      loadServerMetrics();

      // Actualizar VMs expandidas
      Object.keys(expandedServers).forEach((serverNum) => {
        if (expandedServers[serverNum]) {
          loadVMsForServer(serverNum);
        }
      });
    }, 30000);
  });
</script>
{% endblock %}

<script src="{% static 'js/metrics.js' %}"></script>
